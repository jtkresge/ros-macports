# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                $$fullname$$
version             1.0.0
categories          devel
platforms           darwin
license             bsd
maintainers         afit.edu:kyle.kauffman
description         Robotic Operating System
long_description    ROS is a collection of tools and libraries for robotics applications. This installs the $$name$$ package.
homepage            http://www.ros.org/

depends_lib         port:py27-catkin-pkg \
                    port:py27-rosdep \
                    port:py27-rosdistro \
                    port:py27-rosinstall \
                    port:py27-rospkg \
                    port:py27-vcstools \
                    port:py27-wstool \
                    port:ros-collada-dom \
                    port:libyaml \
                    port:yaml-cpp \
                    port:tinyxml \
                    port:pkgconfig \
                    port:ros-log4cxx \
                    port:subversion \
                    port:git-core \
                    port:mercurial \
                    port:google-test \
                    port:py27-yaml \
                    port:py27-empy \
                    port:py27-setuptools \
                    port:py27-dateutil \
                    port:boost \
                    port:poco \
                    port:eigen3 \
                    port:py27-nose \
                    port:tinyxml \
                    port:ossp-uuid \
                    port:gtk2 \
                    port:libtheora \
                    port:assimp \
                    port:py27-pil \
                    port:py27-cairo \
                    port:opencv $$build_depends$$ $$run_depends$$

conflicts           ros-core ros-desktop ros-groovy-core ros-groovy ros-groovy-desktop-full ros-hydro-core

master_sites        $$url_base$$
distfiles           $$url_file$$
worksrcdir          $$extract_dir$$

# todo: calculate checksum
checksum {}
configure {}
configure.compiler clang
configure.cflags-append "-DBOOST_SIGNALS_NO_DEPRECATION_WARNING"

build {
     file delete -force ${worksrcpath}/build_isolated
     file delete -force ${worksrcpath}/devel_isolated
     file delete -force ${worksrcpath}/install_isolated

     set env(LIBRARY_PATH) "${prefix}/lib"
     set env(CPATH) "${prefix}/include/collada-dom2.4:${prefix}/include/collada-dom2.4/1.5:${prefix}/include/gtk-2.0:${prefix}/include/glib-2.0:${prefix}/lib/glib-2.0/include:${prefix}/include/cairo"
     set env(OpenCV_DIR) "${prefix}/lib/cmake/"
     set env(CMAKE_PREFIX_PATH) "${prefix}:${destroot}/opt/local/lib"
     set env(PYTHONPATH) "${prefix}/lib/python2.7/site-packages"

     # Force catkin to use chosen compiler
     set env(CC) "${configure.cc}"
     set env(CXX) "${configure.cxx}"
     set env(CPP) "${configure.cpp}"

     system "DESTDIR=${destroot} $$catkin$$ \
          --source ${worksrcpath} \
          --build ${worksrcpath}/build_isolated \
          --devel ${worksrcpath}/devel_isolated \
          -DCMAKE_SKIP_RPATH:BOOL=OFF \
          -DCMAKE_INSTALL_NAME_DIR:STRING=${prefix}/lib \
          -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=ON \
          -DCMAKE_INSTALL_RPATH_USE_LINK_PATH:BOOL=ON \
          -DSETUPTOOLS_DEB_LAYOUT=OFF \
          -DPYTHON_EXECUTABLE:FILEPATH=${prefix}/bin/python2.7 \
          --install-space=${prefix} \
          --install"
}

destroot {}

# ROS Master URI needs empty .catkin file in ${prefix} if ${prefix} is the ROS install dir
destroot.violate_mtree yes
